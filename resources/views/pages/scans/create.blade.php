@extends('layouts.master')

@section('title')
    {{ trans('pages.scans.title') }}
@endsection

@section('container')
    
    @include('errors.validation')

    <div class="card">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link {{ ($type == 'general-information') ? 'active' : '' }}" href="#general-information" data-toggle="tab"><i class="material-icons">info_outline</i> {{ trans('pages.scans_create.general_information') }}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {{ ($type == 'scan-settings') ? 'active' : '' }}" href="#scan-settings" data-toggle="tab"><i class="material-icons">settings</i> {{ trans('pages.scans_create.scan_settings') }}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {{ ($type == 'schedule-settings') ? 'active' : '' }}" href="#schedule-settings" data-toggle="tab"><i class="material-icons">schedule</i> {{ trans('pages.scans_create.schedule_settings') }}</a>
            </li>
            <li class="nav-item">
                <a class="nav-link {{ ($type == 'completed') ? 'active' : '' }}" href="#scan-completed" data-toggle="tab"><i class="material-icons">done</i> {{ trans('pages.scans_create.scan_completed') }}</a>
            </li>
        </ul>
        <div class="card-header">
            <h4 class="card-title">

                @if($type == 'general-information')

                {{ trans('pages.scans_create.general_information') }}

                @elseif($type == 'scan-settings')

                {{ trans('pages.scans_create.scan_settings') }}

                @elseif($type == 'scan-settings')

                {{ trans('pages.scans_create.schedule_settings') }}

                @elseif($type == 'completed')

                {{ trans('pages.scans_create.completed') }}

                @endif
            </h4>
        </div>
        <form action="{{ route('pages.scans.create', $type) }}" method="POST" autocomplete="off">
            <input type="hidden" name="_token" value="{{ csrf_token() }}">
            <div class="p-a-1">

                @if($type == 'general-information')
                
                <div class="form-group row {{ $errors->has('name') ? 'has-danger' : '' }}">
                    <label for="scan_name" class="col-sm-3 form-control-label">{{ trans('pages.scans.forms.name') }} :</label>
                    <div class="col-sm-9 col-md-4">
                        <div class="input-group">
                            <span class="input-group-addon" id="sizing-addon2">#</span>
                            <input id="scan_name" name="name" type="text" class="form-control {{ $errors->has('name') ? 'form-control-danger' : '' }}" placeholder="{{ trans('pages.scans.forms.name') }}" aria-describedby="sizing-addon2" value="{{ old('name') }}">
                        </div>
                    </div>
                </div>
                <div class="form-group row {{ $errors->has('profile') ? 'has-danger' : '' }}">
                    <label for="scan_profile" class="col-sm-3 form-control-label">{{ trans('pages.scans.forms.profile') }} :</label>
                    <div class="col-sm-9 col-md-4">
                        <select id="scan_profile" name="profile" class="c-select form-control {{ $errors->has('profile') ? 'form-control-danger' : '' }}" placeholder="{{ trans('pages.scans.forms.profile') }}">
                            @foreach($profiles as $profile)
                                <option value="{{ $profile->id }}" {{ $profile->is_default == true ? 'selected' : '' }}>{{ $profile->name }}</option>
                            @endforeach
                        </select>
                    </div>
                </div>
                <div class="form-group row {{ $errors->has('active') ? 'has-danger' : '' }}">
                    <label for="scan_active" class="col-sm-3 form-control-label">{{ trans('pages.scans.forms.active') }} :</label>
                    <div class="col-sm-9">
                        <div class="switch">
                            <input name="active" id="scan_active" class="switch-toggle switch-toggle-round {{ $errors->has('active') ? 'form-control-danger' : '' }}" type="checkbox" checked>
                            <label for="scan_active"></label>
                        </div>
                    </div>
                </div>
                <div class="form-group row {{ $errors->has('description') ? 'has-danger' : '' }}">
                    <label for="scan_description" class="col-sm-3 form-control-label">{{ trans('pages.scans.forms.description') }} :</label>
                    <div class="col-sm-9 col-md-6">
                        <textarea id="scan_description" name="description" class="form-control {{ $errors->has('description') ? 'form-control-danger' : '' }}" rows="4" placeholder="{{ trans('pages.scans.forms.description') }}"></textarea>
                    </div>
                </div>

                @elseif($type == 'scan-settings')

                <div class="card m-t-2">
                    <div class="card-header bg-white">
                        <div class="media">
                            <div class="media-left media-middle">
                                <i class="material-icons">link</i>
                            </div>
                            <div class="media-body media-middle">
                                <h4 class="card-title">{{ trans('pages.scans_create.url_lists') }}</h4>
                            </div>
                            <div class="media-right media-middle">
                                <a href="#" data-toggle="modal" data-target="#modalScanSetting" class="btn btn-primary btn-rounded"><i class="material-icons">add_circle_outline</i></a>
                            </div>
                        </div>
                    </div>
                    <div class="card-block">
                      <ul class="list-group list-group-fit nestable-list-plain m-b-0">
                            <li class="list-group-item nestable-item">
                                <div class="media">
                                    <div class="media-left media-middle">
                                        <i class="material-icons text-success">check</i>
                                    </div>
                                    <div class="media-body media-middle">
                                        <span>http://www.google.com</span>
                                    </div>
                                    <div class="media-right right media-middle">
                                        <div style="width:200px;">
                                            <a href="#" data-toggle="modal" data-target="#modalScanSetting" class="btn btn-primary btn-sm"><i class="material-icons">edit</i> EDIT</a>
                                            <a href="#" data-toggle="modal" data-target="#modalScanSetting" class="btn btn-success btn-sm"><i class="material-icons">sync</i> CHECK</a>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>

                    </div>
                </div>

                <div class="card m-t-2">
                    <div class="card-header bg-white">
                        <div class="media">
                            <div class="media-left media-middle">
                                <i class="material-icons">location_searching</i>
                            </div>
                            <div class="media-body media-middle">
                                <h4 class="card-title">{{ trans('pages.scans_create.asset_lists') }}</h4>
                            </div>
                            <div class="media-right media-middle">
                                <!-- <a href="#" data-toggle="modal" data-target="#modalScanSetting" class="btn btn-primary btn-rounded"><i class="material-icons">add_circle_outline</i></a> -->
                            </div>
                        </div>
                    </div>
                    <div class="card-block">

                        <div class="alert alert-danger alert-dismissible fade in" role="alert">
                            <strong>Comin soon!</strong> This feature will be activated very soon.
                        </div>
                        
                    </div>
                </div>

                @endif
            </div>
            <div class="card-footer clearfix">

                @if($type == 'schedule-settings')
                <a href="#" class="btn btn-white">{{ trans('pages.scans.forms.skip_button') }} <i class="material-icons">skip_next</i></a>
                @endif

                <button type="submit" class="btn btn-success btn-rounded pull-xs-right">{{ trans('pages.scans.forms.next_button') }}<i class="material-icons">navigate_next</i></button>
            </div>
        </form>
    </div>

    @if($type == 'scan-settings')
    <div class="modal fade" id="modalScanSetting">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h5 class="modal-title js-title-step"></h5>
                </div>
                <div class="modal-body">
                    <form action="#" autocomplete="off">
                        <div class="hide" data-step="1" data-title="{{ trans('pages.scans_create.url_checking') }}">
                            <div class="form-group row">
                                <label for="scan_url" class="col-sm-2 form-control-label">{{ trans('pages.scans_create.forms.url') }}</label>
                                <div class="col-sm-10 col-md-10">
                                    <div class="input-group">
                                        <span class="input-group-addon" id="basic-addon2">
                                            <i class="material-icons md-18 text-muted">language</i>
                                        </span>
                                        <input id="scan_url" name="scan_url" class="form-control" placeholder="http://" value="" type="text">
                                    </div>
                                    <small class="text-help">{{ trans('pages.scans_create.forms.url_description') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="hide" data-step="2" data-title="{{ trans('pages.scans_create.url_verification') }}">
                            <div class="card-block">
                                {!! trans('pages.scans_create.forms.url_extra_description') !!}
                            </div>
                        </div>
                        <div id="modalScanResultsBox"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-rounded js-btn-step pull-left" data-orientation="cancel" data-dismiss="modal"></button>
                    <button type="button" class="btn btn-warning btn-rounded js-btn-step" data-orientation="previous"></button>
                    <button type="button" class="btn btn-success btn-rounded js-btn-step" data-orientation="next"></button>
                </div>
            </div>
        </div>
    </div>

    @endif
  
@endsection

@section('scripts')
    <script type="text/javascript">
        $(function(){

            var _ALERT_TEMPLATE = '<div class="alert alert-{T} alert-dismissible fade in" role="alert"><strong>{H}</strong> {M}</div>';

            $('#modalScanSetting').modalSteps({
                btnCancelHtml: '<i class="material-icons">close</i> {{ trans('pages.scans.forms.cancel_button') }}',
                btnPreviousHtml: '<i class="material-icons">navigate_before</i> {{ trans('pages.scans.forms.prev_button') }}',
                btnNextHtml: '{{ trans('pages.scans.forms.next_button') }} <i class="material-icons">navigate_next</i>',
                btnLastStepHtml: '<i class="material-icons">done_all</i> {{ trans('pages.scans.forms.complete_button') }}',
                completeCallback: function(){
                    alert(2);
                },
                callbacks : {
                    '*' : function(step){

                        console.log(step);

                        var _status = true;

                        $('#modalScanResultsBox').html('');
                        
                        if(step == 1){

                            var _url = $('input#scan_url').val();

                            if(!/^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test( _url ))
                            {
                                $('#modalScanResultsBox').html(
                                        _ALERT_TEMPLATE.replaceAll('{T}', 'danger')
                                            .replaceAll('{M}', '{{ trans('pages.scans_create.forms.url_error') }}')
                                            .replaceAll('{H}', 'Oops!')
                                    );

                                $('input#scan_url').focus();

                                _status = false;

                            }else{

                                $.ajax({
                                    url     : '{{ route('api.scans.add_url') }}',
                                    data    : { _url : _url, _token    : $('meta[name=csrf-token]').attr('content') },
                                    method  : 'POST',
                                    success : function(response){
                                        console.log(response);
                                    },
                                    error   : function(response){

                                        console.log(response);

                                        if(response && response.responseJSON && response.responseJSON.message){

                                            Messenger().post({
                                                message: response.responseJSON.message,
                                                type: 'danger',
                                                showCloseButton: true
                                            });

                                        }
                                    }
                                });
                            }
                        }

                        return _status;
                    }
                }
            }).on('shown.bs.modal', function () {
                $('input#scan_url').focus();
            });
        });
    </script>
@endsection